# 学习笔记

## 一、安卓模拟器无法连接网络
###  问题
安卓模拟器无法连接网络，这导致我的应用无法进行GET和POST请求测试。
###  思考
我尝试很多在Android studio的方法去连接wifi，比如修改 DNS 配置和使用桥接模式，但是都不行，最后发现直接用虚拟机的流量可以运行加载图片，但是有点卡顿。

## 二、两个按键被图片挤出可视范围
###  问题
在按了加载键后图片出现两个按键却不见了，一开始还很傻的以为是到了另一个activity，但是想了一下我根本就没弄第二个activty啊，这才反应过来是图片把按键挤出去或者覆盖掉了
###  思考
经过反复测试，我发现问题的根源在于：我没有对ImageView设置合适的宽高导致图片加载后ImageView的实际绘制区域与布局预期不符，后面添加了正确的宽高就成功在加载后仍有按键能重复按了。
## 三、图片加载不出来
###  问题
第一次运行GET请求时，偶尔会出现图片加载不出来的情况，ImageView区域一片空白，没有任何提示。
###  思考
通过Log发现有时从API获取的图片URL是null或空字符串，可能是以为网络波动问题导致下载失败。
因为一个无效URL导致整个应用看起来像卡死，体验很差。Glide本身提供了错误占位图的功能，因此我们应该主动设置，这样子才能知道按键有无反应
Glide.with(MainActivity.this)
    .load(imageUrl)
    .error(android.R.drawable.ic_delete) // 加载失败显示系统默认删除图标
    .into(ivContent);
## 四、按钮快速点击导致网络请求多次发送
###  问题
由于因为第一个问题，导致我经常多次点击加载图片这个按键，从而导致使得ImageView频繁切换图片，且数据库会插入多条重复的图片URL，这使得在使用断网的post请求时，经常点好几下才会更换一个图片
###  思考
因此我去问了ai如何解决得到应该给两个按钮的点击事件添加了防抖处理，即btnGetImage.setEnabled(false);经过这样修改，快速点击按钮时，只有第一次点击生效，后续点击会被忽略直到请求完成。数据库也不再有重复记录。

##五、Room数据库在主线程操作导致应用闪退
###  问题
在实现POST请求将响应数据保存到数据库时，点击按钮后应用直接闪退。
###  思考
查看Log发现异常java.lang.IllegalStateException: Cannot access database on the main thread since it may potentially lock the UI for a long period.
我意识到Room默认禁止在主线程进行数据库操作，而我在按钮的点击事件里直接调用了appDatabase.dogImageDao().insert(...)，触发了这个异常。
问了ai后，我使用最简单的new Thread来包裹数据库操作
// 插入数据
new Thread(() -> {
    appDatabase.dogImageDao().insert(new DogImage(imageUrl, System.currentTimeMillis()));
    appDatabase.dogImageDao().deleteOldImages();
}).start();

// 查询缓存数据
new Thread(() -> {
    List<DogImage> cachedData = appDatabase.dogImageDao().getLatest20Images();
    runOnUiThread(() -> {
        // 更新UI
    });
}).start();经过这样的修改，应用不再闪退，数据库操作正常执行

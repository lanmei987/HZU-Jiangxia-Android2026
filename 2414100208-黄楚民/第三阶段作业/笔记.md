# 学习笔记

## 一、WebView 导致的内存泄漏问题

###  问题
在新闻详情页面多次打开关闭后，app一直崩溃，直到重启才能继续使用，但多次开关后还是一样的情况。

###  思考
多次查询后，最终用Android Studio 的 Memory Profiler 发现问题是由于每次打开详情页都会增加内存，退出后没有完全释放导致的，后我询问ai如何处理，得知WebView 是一个重量级组件，它会持有 Activity 的引用，
如果在 Activity 销毁时没有正确清理，WebView 会一直占用内存，导致泄漏。后又询问ai解决方法，最终得知WebView 需要在从视图树中移除后才能销毁，并且要加载空白页释放资源。
@Override
protected void onDestroy() {
    if (webView != null) {
        webView.stopLoading();
        webView.loadUrl("about:blank");   // 先加载空白页
        webView.clearHistory();           // 清除历史
        webView.removeAllViews();         // 移除子视图
        webView.destroy();                 // 最后销毁
        webView = null;
    }
    super.onDestroy();
}

## 二、新闻页面重叠

###  问题
在 MainActivity 中，使用 ViewPager2 配合 FragmentStateAdapter 管理新闻列表和个人中心页面。当应用被系统回收后重新进入，或者横竖屏旋转时，发现 Fragment 页面重叠或内容显示异常。

###  思考
查询这种情况得知有可能根本原因是在 Activity 重建时，MainPagerAdapter 的 createFragment 被调用多次，导致旧 Fragment 未被移除，多个 Fragment 实例同时存在，从而产生重叠。
我查看了 MainPagerAdapter 的实现，发现它每次 createFragment 都返回一个新的 Fragment 实例，这本身没问题，
但需要确保 Fragment 的状态被正确保存和恢复。我问了ai后采取两个措施，一个是在 Activity 的 onCreate 中，检查 savedInstanceState，如果非空，表示是重建，此时 ViewPager2 会自动恢复 Fragment 状态，另一个是确保 Fragment 有默认构造函数，
并且不传递复杂对象作为参数。

## 三、登录注册界面时键盘遮挡输入框

###  问题
在 LoginActivity 和 RegisterActivity 中，当用户点击输入框时，软键盘弹起会遮挡部分输入框，尤其是底部的按钮。
###  思考
在 AndroidManifest.xml 中，为登录和注册 Activity 添加：

xml
<activity
    android:name=".activity.LoginActivity"
    android:windowSoftInputMode="adjustResize" />
<activity
    android:name=".activity.RegisterActivity"
    android:windowSoftInputMode="adjustResize" />
    这样子后键盘不再遮挡输入区域
    
## 四、浏览历史重复插入多条相同记录

###  问题
反复进出同一篇文章时，数据库中出现大量重复的浏览记录，无意义。
###  思考
浏览历史应该只记录一次访问，如果短时间内重复进入同一篇文章，不应该重复插入。
合理的做法是：如果该文章已存在于浏览记录中，则更新；如果不存在，则插入新记录。我需要在插入前检查是否存在。
public void insert(BrowseHistory history, Callback callback) {
    new Thread(() -> {
        BrowseHistory existing = historyDao.findByUrl(history.getUserId(), history.getNewsUrl());
        if (existing != null) {
            // 更新现有记录
            existing.setTimestamp(System.currentTimeMillis());
            historyDao.update(existing);
        } else {
            historyDao.insert(history);
        }
        // 同时清理超过上限的记录
        historyDao.deleteOldRecords(history.getUserId(), 100);
        if (callback != null) callback.onSuccess();
    }).start();
}
## 五、WebView 返回键直接退出

###  问题v
当点击手机物理返回键，整个 Activity 直接退出，返回到上一个activitiy。

### 思考
点击手机物理返回键，整个 Activity 直接退出，返回到上一个页面，但是如果点击了文章中的链接跳转到其他页面，按返回键应该先回到上一级网页，直到没有历史记录时才退出 Activity。询问ai得知，
默认情况下，Activity 的 onBackPressed() 直接调用 super.onBackPressed() 结束 Activity，没有考虑 WebView 的历史，而canGoBack() 方法检查是否可以后退，以及 goBack() 方法执行后退操作，
故可以使用
@Override
public void onBackPressed() {
    if (webView != null && webView.canGoBack()) {
        webView.goBack();  // 返回上一级网页
    } else {
        super.onBackPressed();  // 没有历史记录时关闭 Activity
    }
}
来保证返回键应该先回到上一级网页，直到没有历史记录时才退出 Activity。
## 六、Glide 加载图片时占位图显示异常或图片变形

###  问题
在新闻列表的 item_news.xml 中，ImageView 固定宽高为 80dp×80dp，但有些图片比例不对，导致拉伸变形
###  思考
Glide 默认的 centerCrop() 或 fitCenter() 可以控制图片的缩放方式。我需要根据需求选择合适的缩放模式。同时，占位图应该使用通用的加载中图标或灰色背景，而不是应用图标。

解决
在适配器的 onBindViewHolder 中，使用 Glide 的 centerCrop() 方法：

java
Glide.with(itemView.getContext())
    .load(imageUrl)
    .placeholder(R.drawable.ic_image_placeholder)  // 自定义占位图
    .error(R.drawable.ic_broken_image)            // 自定义错误图
    .centerCrop()
    .into(ivThumbnail);
这样图片加载时显示占位图，加载失败显示错误图，且图片按比例裁剪填充，不再变形。
